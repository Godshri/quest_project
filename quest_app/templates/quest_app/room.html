{% extends 'quest_app/base.html' %}
{% load static %}

{% block content %}
<div class="game-interface">
    <!-- –ü–æ–ª–æ—Å–∫–∞ –∂–∏–∑–Ω–µ–π -->
    <div class="hearts-bar">
    <span>–ñ–∏–∑–Ω–∏: </span>
        {% for i in "x"|ljust:total_hearts %}
            <i class="fa-solid fa-heart fa-pixel fa-heart {% if forloop.counter0 >= player.hearts %}broken{% endif %}"></i>
        {% endfor %}
    </div>

    <div class="progress-bar">
        <div class="progress-text">
            –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ player.solved_puzzles|length }}/{{ total_puzzles }} –∑–∞–≥–∞–¥–æ–∫
        </div>
        <div class="progress-fill" style="width: {{ progress_percent }}%"></div>
    </div>

    <div class="room">
        <h2>{{ room_name }}</h2>
        
        <div class="room-image-wrapper">
            <div class="room-image {{ room }}" style="background-image: url('{% static 'quest_app/img/' %}{{ room }}.png');">
            </div>
        </div>
        
        <div class="puzzles">
            {% for puzzle in puzzles %}
            <div class="puzzle" data-difficulty="{{ puzzle.difficulty }}">
                <h3><i class="fa-solid fa-puzzle-piece fa-pixel fa-blue"></i> –£—Ä–æ–≤–µ–Ω—å {{ puzzle.difficulty }}: {{ puzzle.name }}</h3>
                <p>{{ puzzle.description }}</p>
                <form class="puzzle-form" data-puzzle-id="{{ puzzle.id }}">
                    {% csrf_token %}
                    <input type="text" name="answer" class="pixel-input" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç...">
                    <button type="submit" class="pixel-button"><i class="fa-solid fa-magnifying-glass fa-pixel"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </form>
                <div class="result-message"></div>
            </div>
            {% empty %}
            <div class="welcome-message">
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–≤–µ—Å—Ç!</h3>
                <p>–í—ã–±–µ—Ä–∏ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è. –ü–æ–º–Ω–∏ - —É —Ç–µ–±—è –µ—Å—Ç—å –∂–∏–∑–Ω–∏!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="navigation">
        <button class="room-button" data-room="server">
            <i class="fa-solid fa-server fa-pixel"></i> –°–µ—Ä–≤–µ—Ä–Ω–∞—è
        </button>
        <button class="room-button" data-room="library">
            <i class="fa-solid fa-book fa-pixel"></i> –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞
        </button>
        <button class="room-button" data-room="arcade">
            <i class="fa-solid fa-gamepad fa-pixel"></i> –ê—Ä–∫–∞–¥–∞
        </button>
        <button class="room-button" data-room="roof">
            <i class="fa-solid fa-building fa-pixel"></i> –ö—Ä—ã—à–∞
        </button>
    </div>
</div>

<!-- –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–Ω–∞—Ç—ã -->
<audio id="bg-music-server" loop>
    <source src="{% static 'quest_app/audio/server_music.mp3' %}" type="audio/mpeg">
</audio>
<audio id="bg-music-library" loop>
    <source src="{% static 'quest_app/audio/library_music.mp3' %}" type="audio/mpeg">
</audio>
<audio id="bg-music-arcade" loop>
    <source src="{% static 'quest_app/audio/arcade_music.mp3' %}" type="audio/mpeg">
</audio>
<audio id="bg-music-roof" loop>
    <source src="{% static 'quest_app/audio/roof_music.mp3' %}" type="audio/mpeg">
</audio>
<audio id="bg-music-start" loop>
    <source src="{% static 'quest_app/audio/start_music.mp3' %}" type="audio/mpeg">
</audio>

<audio id="success-sound">
    <source src="{% static 'quest_app/audio/success.mp3' %}" type="audio/mpeg">
</audio>
<audio id="fail-sound">
    <source src="{% static 'quest_app/audio/fail.mp3' %}" type="audio/mpeg">
</audio>

<div class="sound-controls">
    <button id="mute-button" class="pixel-button">üîä</button>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –º—É–∑—ã–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–º–Ω–∞—Ç—ã
function changeRoomMusic(room) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –º—É–∑—ã–∫–∏
    const allMusic = document.querySelectorAll('audio[id^="bg-music-"]');
    allMusic.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
    });
    
    // –í–∫–ª—é—á–∞–µ–º –º—É–∑—ã–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã
    const roomMusic = document.getElementById(`bg-music-${room}`);
    if (roomMusic) {
        roomMusic.volume = 0.3;
        roomMusic.play().catch(e => console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', e));
    }
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –º—É–∑—ã–∫—É —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const currentRoom = '{{ room }}';
    changeRoomMusic(currentRoom);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –∫–æ–º–Ω–∞—Ç—ã
    document.querySelectorAll('.room-button').forEach(button => {
        button.addEventListener('click', function() {
            const newRoom = this.dataset.room;
            changeRoomMusic(newRoom);
        });
    });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º
let isMuted = false;
const muteButton = document.getElementById('mute-button');

muteButton.addEventListener('click', function() {
    isMuted = !isMuted;
    const allAudio = document.querySelectorAll('audio');
    allAudio.forEach(audio => {
        audio.muted = isMuted;
    });
    muteButton.textContent = isMuted ? 'üîá' : 'üîä';
});

// –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º
document.addEventListener('click', function() {
    const currentRoom = '{{ room }}';
    const roomMusic = document.getElementById(`bg-music-${currentRoom}`);
    if (roomMusic && roomMusic.paused) {
        roomMusic.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
    }
}, { once: true });
</script>
{% endblock %}