{% extends 'quest_app/base.html' %}
{% load static %}

{% block content %}
<div class="game-over-screen">
    <div class="game-over-content">
        <h2>üíÄ –ò–≥—Ä–∞ –û–∫–æ–Ω—á–µ–Ω–∞</h2>
        <div class="broken-heart">üíî</div>
        <p>–¢–≤–æ–∏ —Å–µ—Ä–¥—Ü–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å! –ù–æ –∫–∞–∂–¥—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∑–Ω–∞–µ—Ç - –æ—à–∏–±–∫–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—á–∏—Ç—å—Å—è!</p>
        
        <div class="stats">
            <p>–†–µ—à–µ–Ω–æ –∑–∞–≥–∞–¥–æ–∫: {{ player.solved_puzzles|length }}/12</p>
            <p>–û—Å—Ç–∞–ª–æ—Å—å —Å–µ—Ä–¥–µ—Ü: {{ player.hearts }}</p>
        </div>

        <div class="restart-options">
            <button onclick="resetGame()" class="pixel-button">üîÑ –ù–∞—á–∞—Ç—å –ó–∞–Ω–æ–≤–æ</button>
            <a href="{% url 'index' %}" class="pixel-button">üè† –ù–∞ –ì–ª–∞–≤–Ω—É—é</a>
            <button id="mute-button" class="pixel-button">üîä</button>
        </div>
    </div>
</div>

<audio id="game-over-music">
    <source src="{% static 'quest_app/audio/game_over_music.mp3' %}" type="audio/mpeg">
</audio>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –º—É–∑—ã–∫—É –ø—Ä–æ–∏–≥—Ä—ã—à–∞
    const gameOverMusic = document.getElementById('game-over-music');
    if (gameOverMusic) {
        gameOverMusic.volume = 0.3;
        gameOverMusic.play().catch(e => {
            console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
        });
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º
    let isMuted = false;
    const muteButton = document.getElementById('mute-button');
    
    if (muteButton) {
        muteButton.addEventListener('click', function() {
            isMuted = !isMuted;
            if (gameOverMusic) {
                gameOverMusic.muted = isMuted;
            }
            muteButton.textContent = isMuted ? 'üîá' : 'üîä';
        });
    }
    
    // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
    document.addEventListener('click', function() {
        if (gameOverMusic && gameOverMusic.paused) {
            gameOverMusic.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
        }
    }, { once: true });
});

function resetGame() {
    fetch('/game/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'reset_game'
        })
    }).then(() => {
        location.reload();
    });
}
</script>
{% endblock %}